.model TINY
.code
ORG 100h

START:
    ; ?????? ???????? ????????? ??????
    mov si, 80h                ; ????????? ?? ????????? ??????
    lodsb                      ; ?????? ?????? ???? (????? ??????)
    or al, al
    jz NoParam                 ; ???? ?????? ?????, ???????

    ; ??????????? ???????? ? ?????
    call StrToDec              ; ?????????????? ?????? ? ?????
    or ax, ax
    jz NoParam                 ; ???? ????? ???????, ?????? ?? ???????

    mov cx, ax                 ; ????????? ????? ? CX (???????)

PrintLoop:
    push cx                    ; ????????? CX ????? ??????? ?????????
    call PrintCopyNumber       ; ??????? ????? ??????? ?????
    call RunExternalProgram    ; ??????? ????????? ??????? ???? (4.com)
    call PrintProgramOutput    ; ????? ??????? "Program output:"
    call NewLine               ; ????????? ??????? ??????
    pop cx                     ; ??????????????? CX ????? ??????
    loop PrintLoop             ; ????????? CX ? ?????????, ???? CX > 0

    ; ????????? ?????????
    mov ah, 4Ch
    int 21h

NoParam:
    mov dx, offset NoParamMsg  ; ????? ????????? ?? ?????????? ?????????
    mov ah, 09h
    int 21h
    mov ah, 4Ch
    int 21h

; ????? ?????? ??????? ?????
PrintCopyNumber:
    push ax
    mov dx, offset CopyMsg      ; ????????? "Copy number: "
    mov ah, 09h
    int 21h                    ; ??????? ?????????

    mov di, offset CopyNumBuffer ; ????????????? ????? ??? ??????
    mov ax, cx                 ; ???????? ??????? ????? ????? ? AX
    call AxToStr               ; ??????????? ????? ? ??????
    mov dx, offset CopyNumBuffer ; ????? ?????? ??????
    mov ah, 09h
    int 21h                    ; ??????? ??????
    pop ax
    ret

; ????? "Program output:"
PrintProgramOutput:
    mov dx, offset ProgramOutputMsg ; ????????? "Program output:"
    mov ah, 09h
    int 21h
    ret

; ????????? ??????? ?????? (CR LF)
NewLine:
    mov ah, 02h                ; ??????? DOS: ????? ???????
    mov dl, 0Dh                ; ?????? Carriage Return
    int 21h
    mov dl, 0Ah                ; ?????? Line Feed
    int 21h
    ret

RunExternalProgram:
    ; ??????? ????????? ????? ????????
    mov dx, offset BeforeExecMsg
    mov ah, 09h
    int 21h

    mov ax, 4b00h               ; ????? ?????????
    mov dx, offset ProgramName  ; ??? ?????
    mov bx, offset EPB          ; ????????? ?????????
    int 21h                     ; ????? DOS
    jc ExecError                ; ???? ????????? ??????, ?????????? ??

    ; ????????? ??? ???????? ???????
    mov dx, offset AfterExecMsg
    mov ah, 09h
    int 21h
    ret

ExecError:
    mov dx, offset ExecErrorMsg
    mov ah, 09h
    int 21h

    ; ???????? ??????????
    ret

; ??????????? ?????? ? ?????
StrToDec:
    xor ax, ax                 ; ???????? AX
    xor bx, bx                 ; ???????? BX (??????????)
    lodsb                      ; ?????? ?????? ??????
CheckSpace:
    cmp al, ' '                ; ?????????? ???????
    je CheckSpaceNext
    jmp CheckDigit
CheckSpaceNext:
    lodsb
    jmp CheckSpace

CheckDigit:
    cmp al, '0'
    jb StrToDecEnd             ; ???? ?????? ?????? '0', ?????????
    cmp al, '9'
    ja StrToDecEnd             ; ???? ?????? ?????? '9', ?????????
    sub al, '0'                ; ??????????? ASCII ? ?????
    mov cx, 1
    mul cx                     ; ???????? ?????????? ?? 10
    add ax, bx                 ; ????????? ????? ?????
    mov bx, ax                 ; ????????? ? BX
    lodsb                      ; ????????? ? ?????????? ???????
    jmp CheckDigit

StrToDecEnd:
    mov ax, bx                 ; ?????????? ?????????
    ret

; ??????????? ????? ? ??????
AxToStr:
    xor cx, cx                ; ???????? ??????? ????????
    mov bx, 10                ; ?????? 10 ??? ???????
ConvertLoop:
    xor dx, dx
    div bx                    ; ????? AX ?? 10, ????????? ? AX, ??????? ? DX
    add dl, '0'               ; ??????????? ??????? ? ??????
    push dx                   ; ????????? ?????? ?? ?????
    inc cx                    ; ??????????? ??????? ????????
    or ax, ax
    jnz ConvertLoop           ; ?????????, ???? AX ?? ?????? 0

WriteChars:
    pop dx                    ; ??????????????? ??????? ?? ?????
    mov [di], dl              ; ?????????? ? ?????
    inc di
    loop WriteChars           ; ?????????, ???? ?? ??????? ??? ???????
 
    mov byte ptr [di], '$'    ; ????????? ?????? ???????? '$'
    ret

; ??????
CopyMsg         DB 'Copy number: ', '$'
ProgramOutputMsg DB 0Dh, 0Ah, 'Program output: ', '$'
CopyNumBuffer   DB 6 DUP (0)         ; ????? ??? ?????? ? ??????
NoParamMsg      DB 'NO PARAMETR!!!', 0Dh, 0Ah, '$'
ProgramName     DB '4.COM', 0        ; ??? ????????? ??? ???????
BeforeExecMsg   DB 0Dh, 0Ah, 'Starting 4.com...', 0Dh, 0Ah, '$'
AfterExecMsg    DB 0Dh, 0Ah, 'Returned from 4.com.', 0Dh, 0Ah, '$'
ExecErrorMsg    DB 'Error executing 4.com!', 0Dh, 0Ah, '$'
EPB             DW 0000h
                DW 80h,00h
                DW 5Ch,00h
                DW 6Ch,00h
END START
